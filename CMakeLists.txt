cmake_minimum_required(VERSION 3.8)

project(TAT VERSION 0.0.4 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

enable_testing()

if(CMAKE_CXX_COMPILER MATCHES "mpi")
   message("-- Using mpi compiler directly")
else()
   find_package(MPI)
   if(MPI_FOUND)
      include_directories(${MPI_INCLUDE_PATH})
      link_libraries(${MPI_LIBRARIES})
      message("-- Using mpi by linking mpi libraries")
   else()
      message("-- No mpi support")
   endif()
endif()

if(EMSCRIPTEN)
   link_libraries(${PROJECT_SOURCE_DIR}/emscripten/libf2c.a)
   link_libraries(${PROJECT_SOURCE_DIR}/emscripten/libblas.a)
   link_libraries(${PROJECT_SOURCE_DIR}/emscripten/liblapack.a)
else()
   if (DEFINED ENV{BLA_STATIC})
      set(BLA_STATIC ${BLA_STATIC})
   endif()
   if (DEFINED ENV{BLA_VENDOR})
      set(BLA_VENDOR ${BLA_VENDOR})
   endif()
   find_package(BLAS REQUIRED)
   find_package(LAPACK REQUIRED)
   link_libraries(${BLAS_LIBRARIES} ${LAPACK_LIBRARIES})
endif()

include_directories(${PROJECT_SOURCE_DIR}/include)

file(GLOB CPP_SRC ${PROJECT_SOURCE_DIR}/examples/*.cpp)
foreach(FILE ${CPP_SRC})
   get_filename_component(NAME ${FILE} NAME_WE)
   add_executable(${NAME} ${FILE})
endforeach(FILE)

add_test(simple_test ${PROJECT_BINARY_DIR}/simple_test ${PROJECT_SOURCE_DIR}/examples/simple_test.out)
add_test(diag ${PROJECT_BINARY_DIR}/diag ${PROJECT_SOURCE_DIR}/examples/diag.out)
add_test(mps ${PROJECT_BINARY_DIR}/mps 4 4 100 0.1 10 ${PROJECT_SOURCE_DIR}/examples/mps.out)
add_test(fermi-diag ${PROJECT_BINARY_DIR}/fermi-diag ${PROJECT_SOURCE_DIR}/examples/fermi-diag.out)
add_test(OBC ${PROJECT_BINARY_DIR}/OBC ${PROJECT_SOURCE_DIR}/examples/OBC.out)

find_package(pybind11)
if(pybind11_FOUND)
   message("-- Enable python(system)")
   pybind11_add_module(TAT ${PROJECT_SOURCE_DIR}/python/TAT.cpp)
elseif(EXISTS ${PROJECT_SOURCE_DIR}/pybind11)
   add_subdirectory(pybind11)
   message("-- Enable python(local)")
   pybind11_add_module(TAT ${PROJECT_SOURCE_DIR}/python/TAT.cpp)
else()
   message("-- Disable python")
endif()
